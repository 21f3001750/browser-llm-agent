<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LLM Agent POC ‚Äì Browser Multi‚ÄëTool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #0b1220; color: #e9eef7; }
    .card { background: #0f172a; border: 1px solid #1e293b; }
    .form-control, .form-select { background:#0b1220; color:#e9eef7; border:1px solid #253047; }
    .form-control:focus, .form-select:focus { box-shadow:none; border-color:#475569; }
    .btn-primary { background:#2563eb; border-color:#2563eb; }
    .btn-outline-light { border-color:#334155; }
    .message.agent { background:#111827; color:#e9eef7; }
    .message.user { background:#0b1220; color:#e9eef7; }
    .message.tool { background:#0b2a1a; color:#e9eef7; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
    code { color:#93c5fd; }
    .smallcode { font-size: 0.85rem; }
    .sticky-footer { position: sticky; bottom: 0; background: #0b1220; padding: .5rem; z-index: 5; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex align-items-center mb-3">
    <h1 class="h4 me-3">LLM Agent POC</h1>
    <span class="badge text-bg-secondary">Browser‚Äëbased ¬∑ Tool‚Äëcalling ¬∑ Minimal</span>
  </div>

  <div id="alerts" class="mb-3"></div>

  <div class="row g-3">
    <div class="col-12 col-lg-4">
      <div class="card p-3 mb-3">
        <h2 class="h6">Model Picker</h2>
        <div class="row g-2">
          <div class="col-12">
            <label class="form-label">Provider</label>
            <select id="provider" class="form-select">
              <option value="openai">OpenAI / Compatible</option>
              <option value="aipipe" selected>AI Pipe Proxy</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label">API Base URL</label>
            <input id="baseUrl" class="form-control" value="https://aipipe.org/openai/v1"/>
            <div class="form-text">OpenAI‚Äëstyle /chat/completions endpoint</div>
          </div>
          <div class="col-12">
            <label class="form-label">API Key</label>
            <input id="apiKey" class="form-control" placeholder="sk‚Äë..." />
          </div>
          <div class="col-12">
            <label class="form-label">Model</label>
            <input id="model" class="form-control" value="gpt-4o-mini" />
          </div>
          <div class="col-12">
            <label class="form-label">System Prompt (optional)</label>
            <textarea id="system" class="form-control" rows="2">You are a helpful browser‚Äëbased agent. Think step‚Äëby‚Äëstep. Use tools when helpful. Keep answers concise.</textarea>
          </div>
        </div>
      </div>

      <div class="card p-3 mb-3">
        <h2 class="h6">Google Search API</h2>
        <div class="row g-2">
          <div class="col-12">
            <label class="form-label">Google API Key</label>
            <input id="gKey" class="form-control" placeholder="AIza..." />
          </div>
          <div class="col-12">
            <label class="form-label">Custom Search CX</label>
            <input id="gCx" class="form-control" placeholder="your_cx_id" />
            <div class="form-text">Create at customsearch.google.com</div>
          </div>
        </div>
      </div>

      <div class="card p-3 mb-3">
        <h2 class="h6">AI Pipe Tool</h2>
        <div class="row g-2">
          <div class="col-12">
            <div class="form-text">The tool can POST arbitrary JSON to <code>baseUrl + path</code>. Useful for proxying dataflows.</div>
          </div>
        </div>
      </div>

      <div class="card p-3">
        <h2 class="h6">Runbook</h2>
        <ol class="small mb-0">
          <li>Enter API base & key (AI Pipe works great).</li>
          <li>Provide Google key+cx for search snippets.</li>
          <li>Type a prompt. The agent will loop and call tools until done.</li>
        </ol>
      </div>
    </div>

    <div class="col-12 col-lg-8">
      <div class="card p-3 mb-3">
        <div class="d-flex gap-2 align-items-center">
          <input id="userInput" class="form-control" placeholder="Ask me anything‚Ä¶ e.g., ‚ÄòInterview me to create a blog post‚Äô" />
          <button id="sendBtn" class="btn btn-primary">Send</button>
          <button id="resetBtn" class="btn btn-outline-light">Reset</button>
        </div>
      </div>

      <div class="card p-3" style="min-height: 50vh;">
        <div id="log" class="vstack gap-3"></div>
        <div class="sticky-footer">
          <small class="text-secondary">Tools available to the model: <code>google_search</code>, <code>ai_pipe_api</code>, <code>run_js</code></small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- sandboxed iframe for JS exec -->
<iframe id="sandbox" sandbox="allow-scripts" style="display:none"></iframe>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// --- UI helpers ---
const el = (sel) => document.querySelector(sel);
const log = el('#log');
const alerts = el('#alerts');

function showAlert(msg, type = 'danger') {
  const id = 'al_'+Math.random().toString(36).slice(2);
  const div = document.createElement('div');
  div.className = `alert alert-${type} alert-dismissible fade show`;
  div.setAttribute('role','alert');
  div.innerHTML = `${msg.replace(/</g,'&lt;')}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
  alerts.appendChild(div);
  return id;
}

function appendMessage(role, html) {
  const wrap = document.createElement('div');
  wrap.className = `p-3 rounded message ${role}`;
  wrap.innerHTML = `<div class="small text-secondary mb-1">${role.toUpperCase()}</div><div>${html}</div>`;
  log.appendChild(wrap);
  wrap.scrollIntoView({behavior:'smooth', block:'end'});
}

function escapeHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

// --- LLM call via backend ---
async function callLLM(messages){
  try {
    const res = await fetch("https://browser-llm-agent.onrender.com/chat", {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ message: messages[messages.length - 1].content })
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error(`Backend error ${res.status}: ${text}`);
    }

    return await res.json();
  } catch (err) {
    showAlert("‚ö†Ô∏è Failed to reach backend: " + err.message);
    throw err;
  }
}

// --- Agent loop ---
let MESSAGES = [];

function buildInitialMessages(){
  const sys = el('#system').value.trim();
  const msgs = [];
  if(sys) msgs.push({role:'system', content: sys});
  return msgs;
}

async function agentStep(){
  try{
    const resp = await callLLM(MESSAGES);
    const text = resp.reply || resp.output || JSON.stringify(resp);
    if(text) appendMessage('agent', `<pre>${escapeHtml(text)}</pre>`);
    MESSAGES.push({role:'assistant', content:text});
  } catch(err){
    showAlert(String(err));
  }
}

// --- UI wiring ---
function resetConversation(){
  log.innerHTML = '';
  MESSAGES = buildInitialMessages();
  appendMessage('agent', 'üëã Ready. Talking through backend at <code>/chat</code>.');
}

el('#sendBtn').addEventListener('click', async ()=>{
  const input = el('#userInput');
  const text = input.value.trim();
  if(!text) return;
  input.value = '';
  appendMessage('user', `<pre>${escapeHtml(text)}</pre>`);
  MESSAGES.push({role:'user', content: text});
  await agentStep();
});

el('#resetBtn').addEventListener('click', resetConversation);

el('#userInput').addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); el('#sendBtn').click(); }
});

// boot
resetConversation();
</script>
</body>
</html>